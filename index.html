<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CDL Match Stat Tracker (Two-Team)</title>
<style>
  :root{
    --bg:#0f1115; --card:#151923; --muted:#79839b; --accent:#2ea043; --accent-2:#4aa3ff;
    --text:#e9ecf1; --danger:#ff6363; --warning:#ffb545; --btn:#1e2430; --btn-hover:#242b3a;
    --ring: 0 0 0 2px rgba(74,163,255,.3);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    background:linear-gradient(180deg,#0e1014 0%, #0f1115 60%, #0f1115 100%);
    color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:5;
    backdrop-filter: blur(8px);
    background: rgba(15,17,21,.7);
    border-bottom:1px solid #202633;
  }
  .wrap{max-width:1200px; margin:0 auto; padding:18px 16px}
  h1{font-size:20px; margin:0 0 6px 0}
  .sub{color:var(--muted); font-size:13px}
  .toolbar{
    display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center
  }
  .toolbar input, .toolbar select{
    background:var(--card); color:var(--text); border:1px solid #2a3242; border-radius:8px; padding:10px 12px;
  }
  .btn{
    background:var(--btn); color:var(--text); border:1px solid #2a3242;
    border-radius:10px; padding:10px 14px; cursor:pointer; transition:.15s ease;
    display:inline-flex; align-items:center; gap:8px; user-select:none
  }
  .btn:hover{background:var(--btn-hover)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:#1e2a1f; border-color:#27442a}
  .btn.primary:hover{background:#233122}
  .btn.blue{background:#1a2432; border-color:#24374f}
  .btn.blue:hover{background:#1e2a3a}
  .btn.red{background:#321a1a; border-color:#4f2424}
  .btn.red:hover{background:#3a1e1e}
  .btn.warn{background:#312514; border-color:#4f3a24}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:14px 0}
  .tab-btn{padding:10px 14px; border-radius:10px; border:1px solid #2a3242; background:var(--card); color:var(--text); cursor:pointer}
  .tab-btn.active{outline: var(--ring); border-color:#4aa3ff}
  main{max-width:1200px; margin:10px auto 60px; padding:0 16px; display:grid; gap:16px}
  section.card{
    background:linear-gradient(180deg,#141a24 0%, #121720 100%);
    border:1px solid #202633; border-radius:16px; padding:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25)
  }
  .card h2{margin:0 0 12px 0; font-size:18px}
  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:1024px){
    .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  @media (max-width:640px){
    .grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(1,minmax(0,1fr))}
  }
  .counter{
    padding:12px; border:1px solid #293244; border-radius:12px; background:#111521
  }
  .counter .label{font-size:12px; color:var(--muted); margin-bottom:8px; display:flex; justify-content:space-between; gap:8px; align-items:center}
  .counter .val{font-size:28px; font-weight:700; margin:2px 0 10px}
  .counter .actions{display:flex; gap:8px}
  .counter .actions .btn{flex:1; justify-content:center}
  .muted{color:var(--muted)}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .hill-selector .btn{padding:8px 10px}
  .pill{
    border:1px solid #2a3242; border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted);
  }
  table{
    width:100%; border-collapse:collapse; border:1px solid #202633; background:#0f141e; border-radius:12px; overflow:hidden
  }
  th, td{padding:10px; border-bottom:1px solid #202633; text-align:left}
  th{background:#121826; color:#cfe0ff; font-weight:600}
  tr:last-child td{border-bottom:none}
  .log{max-height:200px; overflow:auto; border:1px dashed #2a3242; border-radius:12px; padding:10px; background:#0e131c}
  .badge{background:#1a2332; border:1px solid #2b3850; padding:6px 10px; border-radius:999px; font-size:12px; color:#cfe0ff}
  .spacer{flex:1}
  .team-toggle .btn{padding:8px 10px}
  .team-active{outline: var(--ring); border-color:#4aa3ff}
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; padding:2px 6px; border:1px solid #2a3242; border-radius:6px; background:#0f151e; color:#d8e1f3}
  .teamname{min-width:160px}
  .tiny{font-size:11px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>CDL Match Stat Tracker</h1>
      <div class="sub">Choose an <strong>Active Team</strong>, then click. Everything autosaves. Use <span class="kbd">Ctrl/Cmd+Z</span> to undo last click.</div>
      <div class="toolbar">
        <input id="matchName" placeholder="Match name (e.g., ATL vs LAT — Map 1)" style="min-width:260px">
        <select id="gameMode">
          <option value="hardpoint">Hardpoint</option>
          <option value="snd">Search &amp; Destroy</option>
          <option value="control">Control</option>
        </select>
        <div class="team-toggle row" aria-label="Active team">
          <input id="teamAName" class="teamname" placeholder="Team A (e.g., OpTic)">
          <button class="btn" id="chooseA">Active: A</button>
          <input id="teamBName" class="teamname" placeholder="Team B (e.g., FaZe)">
          <button class="btn" id="chooseB">Active: B</button>
        </div>
        <button class="btn blue" id="exportCsvBtn">Export CSV</button>
        <button class="btn" id="exportJsonBtn">Export JSON</button>
        <button class="btn warn" id="resetBtn">Reset Current Mode</button>
        <button class="btn red" id="newMatchBtn">New Match (All)</button>
        <span class="spacer"></span>
        <span class="pill tiny" id="autosaveStatus">Autosaved</span>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="hardpointTab">Hardpoint</button>
        <button class="tab-btn" data-tab="sndTab">S&amp;D</button>
        <button class="tab-btn" data-tab="controlTab">Control</button>
        <button class="tab-btn" data-tab="playersTab">Players</button>
        <button class="tab-btn" data-tab="logTab">Log</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Hardpoint -->
    <section class="card" id="hardpointTab">
      <h2>Hardpoint</h2>
      <div class="row hill-selector" style="margin-bottom:12px">
        <span class="muted">Current Hill:</span>
        <div id="hillButtons" class="row" role="group" aria-label="Hill selector"></div>
        <span class="pill">Per-hill stats recorded for the <strong>active team</strong></span>
      </div>

      <!-- Per-hill, side-by-side teams -->
      <div class="grid cols-2" id="hpPerHill"></div>

      <section style="margin-top:14px">
        <div class="row" style="margin-bottom:8px">
          <span class="muted">Totals across all hills</span>
        </div>
        <div class="grid cols-2" id="hpTotals"></div>
      </section>
    </section>

    <!-- SND -->
    <section class="card" id="sndTab" hidden>
      <h2>Search &amp; Destroy</h2>
      <div class="grid cols-2" id="sndCounters"></div>
    </section>

    <!-- Control -->
    <section class="card" id="controlTab" hidden>
      <h2>Control</h2>
      <div class="grid cols-2" id="controlCounters"></div>
      <div class="muted tiny" style="margin-top:8px">Tip: “Ticks Allowed” for one team roughly mirrors the other team’s “Ticks Gained”—log whichever perspective you prefer.</div>
    </section>

    <!-- Players -->
    <section class="card" id="playersTab" hidden>
      <h2>Players</h2>
      <div class="row" style="margin-bottom:12px">
        <input id="playerNameInput" placeholder="Add player name" />
        <select id="playerTeamSelect">
          <option value="A">Team A</option>
          <option value="B">Team B</option>
        </select>
        <button class="btn blue" id="addPlayerBtn">Add Player</button>
        <button class="btn" id="sortPlayersBtn">Sort (A→Z)</button>
        <button class="btn warn" id="resetPlayersBtn">Reset Players</button>
      </div>
      <div class="grid cols-2">
        <div>
          <table id="playersTable">
            <thead>
              <tr><th>Player</th><th>Team</th><th>Kills</th><th>Deaths</th><th>+K</th><th>+D</th><th>−K</th><th>−D</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="grid cols-2">
          <section class="counter">
            <div class="label"><span id="teamATitle">Team A Totals</span></div>
            <div class="row" style="gap:16px; flex-wrap:wrap">
              <div><div class="muted">Kills</div><div class="val" id="teamAKills">0</div></div>
              <div><div class="muted">Deaths</div><div class="val" id="teamADeaths">0</div></div>
              <div><div class="muted">K/D</div><div class="val" id="teamAKD">0.00</div></div>
            </div>
          </section>
          <section class="counter">
            <div class="label"><span id="teamBTitle">Team B Totals</span></div>
            <div class="row" style="gap:16px; flex-wrap:wrap">
              <div><div class="muted">Kills</div><div class="val" id="teamBKills">0</div></div>
              <div><div class="muted">Deaths</div><div class="val" id="teamBDeaths">0</div></div>
              <div><div class="muted">K/D</div><div class="val" id="teamBKD">0.00</div></div>
            </div>
          </section>
        </div>
      </div>
    </section>

    <!-- Log -->
    <section class="card" id="logTab" hidden>
      <h2>Action Log</h2>
      <div class="row" style="margin-bottom:10px">
        <button class="btn" id="undoBtn">Undo Last</button>
        <span class="muted">or press <span class="kbd">Ctrl/Cmd+Z</span></span>
      </div>
      <div class="log" id="logBox"></div>
    </section>
  </main>

<script>
(function(){
  const STORAGE_KEY = 'cdl-tracker-v2';

  const defaultState = () => ({
    meta: { matchName: '', mode: 'hardpoint', currentHill: 'p1', activeTeam: 'A' },
    teams: { A: { name: 'Team A' }, B: { name: 'Team B' } },

    hardpoint: {
      // Per hill, per team
      hills: {
        p1: { A:{breaks:0, holds:0, rotationsWon:0}, B:{breaks:0, holds:0, rotationsWon:0} },
        p2: { A:{breaks:0, holds:0, rotationsWon:0}, B:{breaks:0, holds:0, rotationsWon:0} },
        p3: { A:{breaks:0, holds:0, rotationsWon:0}, B:{breaks:0, holds:0, rotationsWon:0} },
        p4: { A:{breaks:0, holds:0, rotationsWon:0}, B:{breaks:0, holds:0, rotationsWon:0} },
      }
    },

    // SND per team
    snd: {
      A:{ firstBloods:0, plants:0, defuses:0, clutches:0 },
      B:{ firstBloods:0, plants:0, defuses:0, clutches:0 }
    },

    // Control per team
    control: {
      A:{ ticksGained:0, ticksAllowed:0, fullCapsWon:0, fullCapsAllowed:0 },
      B:{ ticksGained:0, ticksAllowed:0, fullCapsWon:0, fullCapsAllowed:0 }
    },

    // Players: {id, name, team:'A'|'B', kills, deaths}
    players: [],
    log: [] // {ts, text, undo}
  });

  let state = load() || defaultState();

  // ---------- Utilities ----------
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); flashAutosave(); }
  function load(){ try{ const d=localStorage.getItem(STORAGE_KEY); return d?JSON.parse(d):null }catch{ return null } }
  function resetMode(mode){
    if(mode === 'hardpoint') state.hardpoint = defaultState().hardpoint;
    if(mode === 'snd') state.snd = defaultState().snd;
    if(mode === 'control') state.control = defaultState().control;
    if(mode === 'players') state.players = [];
    state.log.push({ts:Date.now(), text:`Reset ${mode}`, undo:null});
    save(); render();
  }
  function newMatchAll(){ state = defaultState(); save(); render(); }
  function formatTime(ts){ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
  function flashAutosave(){ const el=document.getElementById('autosaveStatus'); el.textContent='Saved'; el.style.outline='var(--ring)'; setTimeout(()=>{ el.textContent='Autosaved'; el.style.outline='none'; },800); }
  const clamp = n => Math.max(0, n|0);
  const teamLabel = t => (state.teams?.[t]?.name || (t==='A'?'Team A':'Team B'));

  function addLog(text, undo){ state.log.unshift({ts:Date.now(), text, undo}); if(state.log.length>400) state.log.length=400; }

  // Central dispatcher for counters (supports undo)
  function perform(action, payload){
    if(action==='hp'){
      const {hill, key, team, delta} = payload;
      const before = state.hardpoint.hills[hill][team][key];
      state.hardpoint.hills[hill][team][key] = clamp(before + delta);
      addLog(`${delta>0?'+':'−'} ${key} on ${hill.toUpperCase()} for ${teamLabel(team)}`, {type:'hp', hill, key, team, prev: before});
    }
    if(action==='snd'){
      const {key, team, delta} = payload;
      const before = state.snd[team][key];
      state.snd[team][key] = clamp(before + delta);
      addLog(`${delta>0?'+':'−'} S&D ${labelize(key)} for ${teamLabel(team)}`, {type:'snd', key, team, prev: before});
    }
    if(action==='ctrl'){
      const {key, team, delta} = payload;
      const before = state.control[team][key];
      state.control[team][key] = clamp(before + delta);
      addLog(`${delta>0?'+':'−'} Control ${labelize(key)} for ${teamLabel(team)}`, {type:'ctrl', key, team, prev: before});
    }
    if(action==='player'){
      const {id, field, delta} = payload;
      const p = state.players.find(x=>x.id===id);
      if(!p) return;
      const before = p[field];
      p[field] = clamp(before + delta);
      addLog(`${delta>0?'+':'−'} ${field} for ${p.name} (${teamLabel(p.team)})`, {type:'player', id, field, prev: before});
    }
    save(); render();
  }

  function undo(){
    const last = state.log.find(x=>x.undo);
    if(!last) return;
    const u = last.undo;
    if(u.type==='hp'){
      state.hardpoint.hills[u.hill][u.team][u.key] = u.prev;
    }else if(u.type==='snd'){
      state.snd[u.team][u.key] = u.prev;
    }else if(u.type==='ctrl'){
      state.control[u.team][u.key] = u.prev;
    }else if(u.type==='player'){
      const p = state.players.find(x=>x.id===u.id);
      if(p) p[u.field] = u.prev;
    }
    const idx = state.log.indexOf(last);
    if(idx>-1) state.log.splice(idx,1);
    save(); render();
  }

  function labelize(k){
    return ({
      breaks:'Breaks', holds:'Holds', rotationsWon:'Rotations Won',
      firstBloods:'First Bloods', plants:'Plants', defuses:'Defuses', clutches:'Clutches',
      ticksGained:'Ticks Gained', ticksAllowed:'Ticks Allowed', fullCapsWon:'Full Caps Won', fullCapsAllowed:'Full Caps Allowed'
    })[k] || k;
  }

  // ---------- DOM Builders ----------
  function counterEl({label, value, onPlus, onMinus, badge}){
    const wrap = document.createElement('div');
    wrap.className = 'counter';
    wrap.innerHTML = `
      <div class="label"><span>${label}</span>${badge?`<span class="badge">${badge}</span>`:''}</div>
      <div class="val">${value}</div>
      <div class="actions">
        <button class="btn primary" aria-label="Increment ${label}">+1</button>
        <button class="btn" aria-label="Decrement ${label}">−1</button>
      </div>
    `;
    const valEl = wrap.querySelector('.val');
    wrap.querySelectorAll('.btn')[0].addEventListener('click', ()=>{ onPlus(); valEl.textContent=(parseInt(valEl.textContent)||0)+1; });
    wrap.querySelectorAll('.btn')[1].addEventListener('click', ()=>{ onMinus(); valEl.textContent=Math.max(0,(parseInt(valEl.textContent)||0)-1); });
    return wrap;
  }

  function renderTeamToggle(){
    const aBtn = document.getElementById('chooseA');
    const bBtn = document.getElementById('chooseB');
    aBtn.classList.toggle('team-active', state.meta.activeTeam==='A');
    bBtn.classList.toggle('team-active', state.meta.activeTeam==='B');
    document.getElementById('teamATitle').textContent = `${teamLabel('A')} Totals`;
    document.getElementById('teamBTitle').textContent = `${teamLabel('B')} Totals`;
    aBtn.textContent = `Active: ${teamLabel('A')}`;
    bBtn.textContent = `Active: ${teamLabel('B')}`;
  }

  function renderHillButtons(){
    const cont = document.getElementById('hillButtons');
    cont.innerHTML = '';
    ['p1','p2','p3','p4'].forEach(h=>{
      const b = document.createElement('button');
      b.className = 'btn ' + (state.meta.currentHill===h ? 'blue' : '');
      b.textContent = h.toUpperCase();
      b.addEventListener('click', ()=>{ state.meta.currentHill = h; save(); render(); });
      cont.appendChild(b);
    });
  }

  function renderHpPerHill(){
    const cont = document.getElementById('hpPerHill');
    cont.innerHTML = '';
    Object.entries(state.hardpoint.hills).forEach(([hill, obj])=>{
      const panel = document.createElement('section');
      panel.className='counter';
      panel.innerHTML = `<div class="label"><span>Hill ${hill.toUpperCase()}</span>${state.meta.currentHill===hill?`<span class="badge">Current</span>`:''}</div>`;
      const grid = document.createElement('div'); grid.className='grid cols-2';

      // Team A column
      const colA = document.createElement('div'); colA.className='grid cols-3';
      ['breaks','holds','rotationsWon'].forEach(key=>{
        colA.appendChild(counterEl({
          label: `${labelize(key)} — ${teamLabel('A')}`,
          value: obj.A[key],
          badge: (state.meta.activeTeam==='A'?'Active':''),
          onPlus: ()=>perform('hp', {hill, key, team:'A', delta:+1}),
          onMinus: ()=>perform('hp', {hill, key, team:'A', delta:-1}),
        }));
      });

      // Team B column
      const colB = document.createElement('div'); colB.className='grid cols-3';
      ['breaks','holds','rotationsWon'].forEach(key=>{
        colB.appendChild(counterEl({
          label: `${labelize(key)} — ${teamLabel('B')}`,
          value: obj.B[key],
          badge: (state.meta.activeTeam==='B'?'Active':''),
          onPlus: ()=>perform('hp', {hill, key, team:'B', delta:+1}),
          onMinus: ()=>perform('hp', {hill, key, team:'B', delta:-1}),
        }));
      });

      grid.appendChild(colA); grid.appendChild(colB);
      panel.appendChild(grid);
      cont.appendChild(panel);
    });
  }

  function renderHpTotals(){
    const cont = document.getElementById('hpTotals');
    cont.innerHTML = '';

    const totalsA = {breaks:0, holds:0, rotationsWon:0};
    const totalsB = {breaks:0, holds:0, rotationsWon:0};
    for(const h of Object.values(state.hardpoint.hills)){
      totalsA.breaks += h.A.breaks; totalsA.holds += h.A.holds; totalsA.rotationsWon += h.A.rotationsWon;
      totalsB.breaks += h.B.breaks; totalsB.holds += h.B.holds; totalsB.rotationsWon += h.B.rotationsWon;
    }

    const mkTotalsCard = (team, totals) => {
      const card = document.createElement('section'); card.className='counter';
      card.innerHTML = `<div class="label"><span>Total — ${teamLabel(team)}</span></div>`;
      const grid = document.createElement('div'); grid.className='grid cols-3';
      ['breaks','holds','rotationsWon'].forEach(key=>{
        const wrap = document.createElement('div'); wrap.className='counter';
        wrap.innerHTML = `<div class="label"><span>${labelize(key)}</span></div><div class="val total">${totals[key]}</div>`;
        grid.appendChild(wrap);
      });
      card.appendChild(grid);
      return card;
    };

    cont.appendChild(mkTotalsCard('A', totalsA));
    cont.appendChild(mkTotalsCard('B', totalsB));
  }

  function renderSND(){
    const cont = document.getElementById('sndCounters');
    cont.innerHTML = '';

    const mkCol = (team) => {
      const col = document.createElement('div'); col.className='grid cols-3';
      ['firstBloods','plants','defuses','clutches'].forEach(key=>{
        col.appendChild(counterEl({
          label: `${labelize(key)} — ${teamLabel(team)}`,
          value: state.snd[team][key],
          badge: (state.meta.activeTeam===team?'Active':''),
          onPlus: ()=>perform('snd', {key, team, delta:+1}),
          onMinus: ()=>perform('snd', {key, team, delta:-1}),
        }));
      });
      return col;
    };

    cont.appendChild(mkCol('A'));
    cont.appendChild(mkCol('B'));
  }

  function renderControl(){
    const cont = document.getElementById('controlCounters');
    cont.innerHTML = '';

    const mkCol = (team) => {
      const col = document.createElement('div'); col.className='grid cols-2';
      ['ticksGained','ticksAllowed','fullCapsWon','fullCapsAllowed'].forEach(key=>{
        col.appendChild(counterEl({
          label: `${labelize(key)} — ${teamLabel(team)}`,
          value: state.control[team][key],
          badge: (state.meta.activeTeam===team?'Active':''),
          onPlus: ()=>perform('ctrl', {key, team, delta:+1}),
          onMinus: ()=>perform('ctrl', {key, team, delta:-1}),
        }));
      });
      return col;
    };

    cont.appendChild(mkCol('A'));
    cont.appendChild(mkCol('B'));
  }

  function renderPlayers(){
    const tbody = document.querySelector('#playersTable tbody');
    tbody.innerHTML = '';
    let aKills=0,aDeaths=0,bKills=0,bDeaths=0;

    state.players.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${teamLabel(p.team)}</td>
        <td>${p.kills}</td>
        <td>${p.deaths}</td>
        <td><button class="btn primary" aria-label="Add kill">+K</button></td>
        <td><button class="btn blue" aria-label="Add death">+D</button></td>
        <td><button class="btn" aria-label="Remove kill">−K</button></td>
        <td><button class="btn" aria-label="Remove death">−D</button></td>
      `;
      const [addK, addD, subK, subD] = tr.querySelectorAll('button');
      addK.addEventListener('click', ()=>perform('player', {id:p.id, field:'kills', delta:+1}));
      addD.addEventListener('click', ()=>perform('player', {id:p.id, field:'deaths', delta:+1}));
      subK.addEventListener('click', ()=>perform('player', {id:p.id, field:'kills', delta:-1}));
      subD.addEventListener('click', ()=>perform('player', {id:p.id, field:'deaths', delta:-1}));
      tbody.appendChild(tr);

      if(p.team==='A'){ aKills+=p.kills; aDeaths+=p.deaths; } else { bKills+=p.kills; bDeaths+=p.deaths; }
    });

    // Team summaries
    document.getElementById('teamAKills').textContent = aKills;
    document.getElementById('teamADeaths').textContent = aDeaths;
    document.getElementById('teamAKD').textContent = aDeaths ? (aKills/aDeaths).toFixed(2) : (aKills? '∞':'0.00');

    document.getElementById('teamBKills').textContent = bKills;
    document.getElementById('teamBDeaths').textContent = bDeaths;
    document.getElementById('teamBKD').textContent = bDeaths ? (bKills/bDeaths).toFixed(2) : (bKills? '∞':'0.00');
  }

  function renderLog(){
    const box = document.getElementById('logBox');
    box.innerHTML = '';
    if(!state.log.length){ box.innerHTML = '<span class="muted">No actions yet…</span>'; return; }
    state.log.forEach(item=>{
      const row = document.createElement('div');
      row.className='row'; row.style.marginBottom='6px';
      row.innerHTML = `<span class="muted">${formatTime(item.ts)}</span> <span>${item.text}</span>`;
      box.appendChild(row);
    });
  }

  function renderTabs(){
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.tab.startsWith(state.meta.mode));
    });
    document.getElementById('hardpointTab').hidden = state.meta.mode!=='hardpoint';
    document.getElementById('sndTab').hidden = state.meta.mode!=='snd';
    document.getElementById('controlTab').hidden = state.meta.mode!=='control';
    document.getElementById('playersTab').hidden = state.meta.mode!=='players';
    document.getElementById('logTab').hidden = state.meta.mode!=='log';
    document.getElementById('gameMode').value = state.meta.mode;
  }

  function renderMeta(){
    document.getElementById('matchName').value = state.meta.matchName || '';
    document.getElementById('teamAName').value = state.teams.A.name || '';
    document.getElementById('teamBName').value = state.teams.B.name || '';
    renderTeamToggle();
  }

  function render(){
    renderTabs();
    renderMeta();
    renderHillButtons();
    renderHpPerHill();
    renderHpTotals();
    renderSND();
    renderControl();
    renderPlayers();
    renderLog();
  }

  // ---------- Export ----------
  function exportJSON(){
    const payload = JSON.stringify(state, null, 2);
    downloadFile('cdl-stats.json', payload, 'application/json');
  }
  function exportCSV(){
    const lines = [];
    const m = (state.meta.matchName||'').replaceAll(/[\n\r,]+/g,' ').trim();
    lines.push(`Match,${m}`);
    lines.push(`Timestamp,${new Date().toISOString()}`);
    lines.push(`Teams,${teamLabel('A')},${teamLabel('B')}`);
    lines.push('');

    // Hardpoint per hill (per team)
    lines.push('Hardpoint (per hill, per team)');
    lines.push('Hill,Team,Breaks,Holds,Rotations Won');
    for(const [hill,vals] of Object.entries(state.hardpoint.hills)){
      lines.push(`${hill.toUpperCase()},${teamLabel('A')},${vals.A.breaks},${vals.A.holds},${vals.A.rotationsWon}`);
      lines.push(`${hill.toUpperCase()},${teamLabel('B')},${vals.B.breaks},${vals.B.holds},${vals.B.rotationsWon}`);
    }
    // Totals
    const tA={breaks:0,holds:0,rotationsWon:0}, tB={breaks:0,holds:0,rotationsWon:0};
    for(const v of Object.values(state.hardpoint.hills)){
      tA.breaks+=v.A.breaks; tA.holds+=v.A.holds; tA.rotationsWon+=v.A.rotationsWon;
      tB.breaks+=v.B.breaks; tB.holds+=v.B.holds; tB.rotationsWon+=v.B.rotationsWon;
    }
    lines.push(`TOTAL,${teamLabel('A')},${tA.breaks},${tA.holds},${tA.rotationsWon}`);
    lines.push(`TOTAL,${teamLabel('B')},${tB.breaks},${tB.holds},${tB.rotationsWon}`);
    lines.push('');

    // SND
    lines.push('Search & Destroy (per team)');
    lines.push('Team,First Bloods,Plants,Defuses,Clutches');
    lines.push(`${teamLabel('A')},${state.snd.A.firstBloods},${state.snd.A.plants},${state.snd.A.defuses},${state.snd.A.clutches}`);
    lines.push(`${teamLabel('B')},${state.snd.B.firstBloods},${state.snd.B.plants},${state.snd.B.defuses},${state.snd.B.clutches}`);
    lines.push('');

    // Control
    lines.push('Control (per team)');
    lines.push('Team,Ticks Gained,Ticks Allowed,Full Caps Won,Full Caps Allowed');
    lines.push(`${teamLabel('A')},${state.control.A.ticksGained},${state.control.A.ticksAllowed},${state.control.A.fullCapsWon},${state.control.A.fullCapsAllowed}`);
    lines.push(`${teamLabel('B')},${state.control.B.ticksGained},${state.control.B.ticksAllowed},${state.control.B.fullCapsWon},${state.control.B.fullCapsAllowed}`);
    lines.push('');

    // Players
    lines.push('Players');
    lines.push('Player,Team,Kills,Deaths,KD');
    state.players.forEach(p=>{
      const kd = p.deaths ? (p.kills/p.deaths).toFixed(2) : (p.kills? '∞':'0.00');
      lines.push(`${sanitize(p.name)},${teamLabel(p.team)},${p.kills},${p.deaths},${kd}`);
    });

    downloadFile('cdl-stats.csv', lines.join('\n'), 'text/csv');
  }
  function sanitize(s){ return (s||'').replaceAll(/[\n\r,]+/g,' ').trim(); }
  function downloadFile(filename, content, mime){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a);
    a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  // ---------- Events / Init ----------
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const tab = b.dataset.tab;
      if(tab.startsWith('hardpoint')) state.meta.mode='hardpoint';
      if(tab.startsWith('snd')) state.meta.mode='snd';
      if(tab.startsWith('control')) state.meta.mode='control';
      if(tab.startsWith('players')) state.meta.mode='players';
      if(tab.startsWith('log')) state.meta.mode='log';
      save(); render();
    });
  });
  document.getElementById('gameMode').addEventListener('change', e=>{ state.meta.mode=e.target.value; save(); render(); });

  // Team names + active team
  document.getElementById('teamAName').addEventListener('input', e=>{ state.teams.A.name = e.target.value||'Team A'; save(); renderTeamToggle(); });
  document.getElementById('teamBName').addEventListener('input', e=>{ state.teams.B.name = e.target.value||'Team B'; save(); renderTeamToggle(); });
  document.getElementById('chooseA').addEventListener('click', ()=>{ state.meta.activeTeam='A'; save(); renderTeamToggle(); });
  document.getElementById('chooseB').addEventListener('click', ()=>{ state.meta.activeTeam='B'; save(); renderTeamToggle(); });

  document.getElementById('matchName').addEventListener('input', e=>{ state.meta.matchName=e.target.value; save(); });

  document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
  document.getElementById('exportJsonBtn').addEventListener('click', exportJSON);

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(confirm(`Reset ${state.meta.mode} stats? This cannot be undone.`)){ resetMode(state.meta.mode); }
  });
  document.getElementById('newMatchBtn').addEventListener('click', ()=>{
    if(confirm('Start a brand new match (clear ALL stats)?')){ newMatchAll(); }
  });

  // Players
  document.getElementById('addPlayerBtn').addEventListener('click', ()=>{
    const name = document.getElementById('playerNameInput').value.trim();
    const team = document.getElementById('playerTeamSelect').value;
    if(!name) return;
    state.players.push({id: crypto.randomUUID(), name, team, kills:0, deaths:0});
    addLog(`Added player ${name} (${teamLabel(team)})`, null);
    document.getElementById('playerNameInput').value='';
    save(); render();
  });
  document.getElementById('sortPlayersBtn').addEventListener('click', ()=>{
    state.players.sort((a,b)=>a.name.localeCompare(b.name)); save(); render();
  });
  document.getElementById('resetPlayersBtn').addEventListener('click', ()=>{
    if(confirm('Remove all players and their stats?')){ resetMode('players'); }
  });

  // Log + undo
  document.getElementById('undoBtn').addEventListener('click', undo);
  window.addEventListener('keydown', (e)=>{
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    if((isMac && e.metaKey && e.key==='z') || (!isMac && e.ctrlKey && e.key==='z')){
      e.preventDefault(); undo();
    }
    // Quick keys: 1/2/3/4 switch hill; A/B switch active team
    if(!e.ctrlKey && !e.metaKey){
      if(['1','2','3','4'].includes(e.key)){
        state.meta.currentHill = 'p'+e.key; save(); render();
      }
      if(e.key.toLowerCase()==='a'){ state.meta.activeTeam='A'; save(); renderTeamToggle(); }
      if(e.key.toLowerCase()==='b'){ state.meta.activeTeam='B'; save(); renderTeamToggle(); }
    }
  });

  // Initial render
  render();

})();
</script>
</body>
</html>
